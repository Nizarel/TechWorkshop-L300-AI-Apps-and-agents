name: Build and Push Docker image to Azure Container Registry

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: Build and push image to ACR
    runs-on: ubuntu-latest

    env:
      REGISTRY_RAW: ${{ secrets.AZURE_CONTAINER_REGISTRY }} # can be either name or full login server
      IMAGE_NAME: my-app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use A2A branch for the workflow code itself
          ref: main

      - name: Derive registry login server
        id: derive
        run: |
          if [ -z "${{ env.REGISTRY_RAW }}" ]; then echo "AZURE_CONTAINER_REGISTRY secret not set" && exit 1; fi
          RAW="${{ env.REGISTRY_RAW }}"
          # Append suffix if user provided just the name
          if [[ "$RAW" != *".azurecr.io" ]]; then RAW="$RAW.azurecr.io"; fi
          echo "REGISTRY_SERVER=$RAW" >> $GITHUB_ENV
          echo "server=$RAW" >> $GITHUB_OUTPUT
          echo "Using registry server: $RAW"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker login (username/password)
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.derive.outputs.server }}
          username: ${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}
          password: ${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}

      - name: Build and push Docker image (context = src/)
        uses: docker/build-push-action@v6
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: |
            ${{ steps.derive.outputs.server }}/${{ env.IMAGE_NAME }}:latest
            ${{ steps.derive.outputs.server }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          # No build secrets or args baked in; runtime env vars supplied at deploy time.
